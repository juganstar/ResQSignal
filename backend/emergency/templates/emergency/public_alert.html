{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Automatic Emergency Alert</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Home screen manifest + icons -->
  <link rel="manifest" href="/manifest/{{ token }}.json">
  <link rel="icon" href="{% static 'icons/icon-192.png' %}" type="image/png">
  <meta name="theme-color" content="#e60023">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="LiveSignal">
  <link rel="apple-touch-icon" href="{% static 'icons/icon-192.png' %}">

  <style>
    body {
      background: linear-gradient(to bottom, #000000, #1a1a1a);
      color: white;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 60px 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      margin: 20px auto;
      border: 4px solid rgba(107, 33, 168, 0.3);
      border-top: 4px solid #6b21a8;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status {
      font-size: 1.2rem;
      margin: 20px 0;
      max-width: 400px;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    .location {
      color: #93c5fd;
      font-size: 0.9rem;
      margin-top: 10px;
    }
    .hidden {
      display: none;
    }
    .footer {
      position: fixed;
      bottom: 20px;
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div id="spinner" class="spinner"></div>
  <div id="status" class="status">Activating emergency alert...</div>
  <div id="location" class="location hidden"></div>
  <div class="footer">Automatic Alert System - Do not close this page</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const spinner = document.getElementById('spinner');
    const statusEl = document.getElementById('status');
    const locationEl = document.getElementById('location');
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const token = pathParts[pathParts.length - 1];

    let firstAlertSent = false;
    let latestLocation = null;

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function updateStatus(type, message, location = null) {
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      if (location) {
        locationEl.textContent = `Location: ${location}`;
        locationEl.classList.remove('hidden');
      } else {
        locationEl.classList.add('hidden');
      }
      if (type === 'success') {
        spinner.style.borderTopColor = '#4ade80';
      } else if (type === 'error') {
        spinner.style.borderTopColor = '#f87171';
      } else if (type === 'warning') {
        spinner.style.borderTopColor = '#fbbf24';
      }
    }

    function sendLocation(lat, lon, isInitial = false) {
      const locationString = lat && lon ? `${lat},${lon}` : null;
      if (isInitial) {
        latestLocation = locationString;
      }

      const payload = {
        location: locationString,
        message: isInitial ? 'üö® Emergency alert activated!' : undefined,
        continuous: !isInitial
      };

      fetch(`/api/emergency/public/${token}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken') || ''
        },
        body: JSON.stringify(payload),
        credentials: 'include'
      })
      .then(async res => {
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(data.detail || data.message || 'Server error');
        }

        if (isInitial) {
          const locationToShow = data?.location_shared ? latestLocation : null;
          updateStatus('success', '‚úÖ Alert sent successfully!', locationToShow);
          setTimeout(() => { spinner.style.animation = 'none'; }, 1000);
        } else {
          console.log("üìç Location update:", lat, lon);
        }
        return data;
      })
      .catch(err => {
        console.error('Location sending error:', err);
        if (isInitial) {
          updateStatus('error', `‚ùå Alert failed: ${err.message}`);
          spinner.style.animation = 'none';
        }
      });
    }

    function startLocationTracking() {
      if (!('geolocation' in navigator)) {
        updateStatus('error', 'Geolocation not supported');
        sendLocation(null, null, true);
        return;
      }

      navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          if (!firstAlertSent) {
            firstAlertSent = true;
            sendLocation(latitude, longitude, true);
          } else {
            sendLocation(latitude, longitude, false);
          }
        },
        err => {
          console.warn('Geolocation error:', err);
          updateStatus('warning', 'Alert sent without location');
          if (!firstAlertSent) {
            firstAlertSent = true;
            sendLocation(null, null, true);
          }
        },
        { 
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        }
      );
    }

    startLocationTracking();
  });
</script>

<script>
  // Register minimal service worker for PWA install prompt
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/sw.js')
      .then(() => console.log("‚úÖ Service Worker registered"))
      .catch((err) => console.error("‚ùå SW registration failed:", err));
  }
</script>

</body>
</html>
